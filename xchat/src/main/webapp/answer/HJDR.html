<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>黄金答人</title>
    <link href="./HJDR.css" rel="stylesheet">
    <script src="../coder/js/baseJS.js"></script>
    <script src="../coder/js/sockjs-0.3.min.js"></script>
</head>
<body>
<br/>
<input id="flag" type="text" disabled class="input-group-sm  col-sm-1">
<input id="text" type="text" class="input-group-sm  col-sm-3"/>
<button onclick="setAuth()" class="btn-group-sm btn-primary search-btn">设置AUTH</button>
<button onclick="getQuestion($(this))" class="btn-primary btn-group-sm search-btn" value="1">关闭开关</button>
<button onclick="closeWebSocket()" class="btn-group-sm btn-danger search-btn">关闭socket</button>
<hr class="hjdr_hr"/>
<span id="message" class="col-sm-3"></span><span id="dd-answer"></span><br/>
 <span id="commonword" class="col-sm-3" style="font-size: 16px"> </span><span id="relation"  class="col-sm-6" style="font-size: 18px;color:orangered;font-weight: 500"></span>
<iframe id="answer" src=""></iframe>
</body>
<script type="text/javascript">
    var websocket = null;
    WebSocket.prototype.isOpen = false;
    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://dev.edu.cn/coder/websocket/socketServer.do");
    }
    else {
        websocket = new SockJS("http://dev.edu.cn/coder/websocket/sockjs/socketServer.do");
//        window.parent.alertCommon('当前浏览器 Not support websocket')
    }

    //连接发生错误的回调方法
    websocket.onerror = function () {
        console.log("error。。。")
        websocket.isOpen = false;
        setMessageInnerHTML("WebSocket连接发生错误");
    };

    //连接成功建立的回调方法
    websocket.onopen = function () {
        console.log("打开连接了")
        setMessageInnerHTML("WebSocket连接成功");
        websocket.isOpen = true;
        setInterval(function () {
            if (websocket.isOpen) {
                websocket.send("ping..........")
            }
        }, 8000);
    }
    //接收到消息的回调方法
    websocket.onmessage = function (event) {
        console.log("收到消息了" + event.data)
//        var result =JSON.parse(event.data);
        if (event.data.indexOf("pong") == -1&&event.data.indexOf("relation") == -1) {
            setMessageInnerHTML(event.data);
            searchAnswere(event.data);
        }
        if(event.data.indexOf("relation")>=0){
            $("#relation").text(event.data.substr(9));
        }
        if(event.data.indexOf("commonword")>=0){
            $("#commonword").text(event.data.substr(11));
        }
    }

    //连接关闭的回调方法
    websocket.onclose = function () {
        setMessageInnerHTML("WebSocket连接关闭");
        websocket.isOpen = false;
    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
        closeWebSocket();
    }

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        var msgs = innerHTML.split("@");

        if (msgs.length > 1) {
            if (msgs[0] == 3) {
                if (msgs[1] == 1) {
                    $("#flag").val("开！");
                    $("#flag").removeClass("error");
                    $("#flag").addClass("suc");
                } else {
                    $("#flag").val("关！");
                    $("#flag").removeClass("suc");
                    $("#flag").addClass("error");
                }
            } else if (msgs[0] == 'answer') {
                document.getElementById('dd-answer').innerHTML = msgs[1] + '';

            } else {
                document.getElementById('message').innerHTML = msgs[1] + '';
                $("#dd-answer").empty();
            }
        } else {
            document.getElementById('message').innerHTML = innerHTML + '';
            $("#dd-answer").empty();
        }


    }
    function searchAnswere(innerHTML) {
        var msgs = innerHTML.split("@");
        if (msgs.length > 0 && msgs[0] == '2') {
            var word = msgs[1];

            document.getElementById('answer').src = 'https://www.baidu.com/s?wd=' + encodeURI(word);
        }
    }
    //关闭WebSocket连接
    function closeWebSocket() {
        websocket.send("8888");
        websocket.close();
        websocket.isOpen = false;
        setMessageInnerHTML("WebSocket连接关闭");
    }

    //发送消息
    function send() {
        var message = document.getElementById('text').value;
        websocket.send(message);
    }
    function setAuth() {
        var auth = $("#text").val();
        if (auth == undefined || auth == '') {
            window.parent.alertCommon("AUTH 内容不能为空！");
            return;
        }
        ajaxObject.postFormAjax(setAuth_URL + "?auth=" + auth, {}, window.parent.callback, "JSON");
    }
    function getQuestion(obj) {
        ajaxObject.postFormAjax(setQuestionFlag_V, {"params": obj.val()}, function (data) {
            if (data.code == 200) {
                if (obj.val() == "1") {
                    obj.val("0");
                    obj.text("打开开关");

                } else {
                    obj.val("1");
                    obj.text("关闭开关");
                }
//                window.parent.alertSuccess(data.msg);
            } else {
//                window.parent.alertError(data.msg);
            }
        }, "JSON");

    }

    //ifame 获取上级元素
    //    function getTicket(){
    //      return  $("#passport_token",window.parent.document).val();
    //    }
</script>
</html>